name: Deploy to EC2

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-1
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ec2-user
  APP_NAME: game-store-backend
  JAR_NAME: ShopGameManagement-0.0.1-SNAPSHOT.jar

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'corretto'
        cache: maven

    - name: Build with Maven
      run: |
        cd Back-End
        chmod +x mvnw
        ./mvnw clean package -DskipTests

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2-key.pem
        chmod 600 ~/.ssh/ec2-key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Create application directory on EC2
      run: |
        ssh -i ~/.ssh/ec2-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
          "mkdir -p /home/ec2-user/${{ env.APP_NAME }}"

    - name: Upload JAR to EC2
      run: |
        scp -i ~/.ssh/ec2-key.pem \
          Back-End/target/${{ env.JAR_NAME }} \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/ec2-user/${{ env.APP_NAME }}/

    - name: Upload service file
      run: |
        scp -i ~/.ssh/ec2-key.pem \
          Back-End/game-store-backend.service \
          ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:/home/ec2-user/

    - name: Deploy application
      run: |
        ssh -i ~/.ssh/ec2-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
          # Move service file
          sudo mv /home/ec2-user/game-store-backend.service /etc/systemd/system/ || true
          
          # Create log directory
          sudo mkdir -p /var/log/game-store
          sudo chown ec2-user:ec2-user /var/log/game-store
          
          # Reload systemd
          sudo systemctl daemon-reload
          
          # Restart service
          sudo systemctl restart game-store-backend
          
          # Enable service
          sudo systemctl enable game-store-backend
          
          # Wait for service to start
          sleep 5
          
          # Check status
          sudo systemctl status game-store-backend
        EOF

    - name: Health check
      run: |
        sleep 10
        ssh -i ~/.ssh/ec2-key.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} \
          "curl -f http://localhost:8080/identity/actuator/health || exit 1"

    - name: Cleanup
      if: always()
      run: |
        rm -f ~/.ssh/ec2-key.pem

    - name: Notify deployment
      if: success()
      run: |
        echo "Deployment successful to EC2: ${{ env.EC2_HOST }}"

    - name: Notify failure
      if: failure()
      run: |
        echo "Deployment failed. Check logs for details."

